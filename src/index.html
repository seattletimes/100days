<%
var moment = require("moment");

%><!doctype html>
<html>
  <head>
    <%= t.include("partials/_head.html") %>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  </head>
  <body>

    <%= t.include("partials/_nav.html") %>


    <section class="title">
      <h1 class="headline">Trump's first 100 days</h1>
    </section>

    <main class="content">

    <section class="introduction">
      <p class="intro">As of today, President Donald Trump has been in office for <b><span class="currentDay"></span> days</b>. We're tracking the statuses of promises outlined in his <a href="https://assets.donaldjtrump.com/CONTRACT_FOR_THE_VOTER.pdf">"Contract with the American Voter,"</a> which contains his plan for his first 100 days in office. He has <b><span class="days-remaining"></span> days</b> remaining in this period.</p>
    </section>

    <section class="progress-bar">

      <%
        var progressByStatus = {};
        var statusCount = 0;
        json.goals.forEach(function(g) {
        var stat = g.promise_status;
        if (!stat) return;
        if (!progressByStatus[stat]) progressByStatus[stat] = 0;
        if (stat) {
          progressByStatus[stat]++;
          if (stat !== "none") statusCount++;
      }
      });

      %>

      <div class="bar-label">Status of Trump's promises</div>
      <div class="bar-container">
        <div class="completed" style="width: <%= (statusCount / json.goals.length * 100).toFixed(2) %>%">
          <% for (var s in progressByStatus) { 
            if (s !== "none") {%>
              <div
                style="width: <%= (progressByStatus[s] / statusCount * 100).toFixed(2) %>%"
                class="bar <%= s.toLowerCase() %>"
              ></div><% } 
            } %>
        </div>
      </div>

      <!-- legend -->
      <div class="legend">
        <ul class="legend-key">
          <% for (var s in progressByStatus) { %>
          <li class="status-legend <%= s.toLowerCase() %>">

            <div class="status-title">
              <% if (s == "none"){ %> 
                No action <% }
                
                else if (s == "progress") { %>
                  In progress
                <% } 
               
                else { %>
                <%= s %>
                <% } %>
              </div>
            
            <div class="quantity"> <%= progressByStatus[s] %> </div>

          </li>
          <% } %>
        </ul>
      </div>

    </section>

        <%
        var byDay = {};
        json.daily.forEach(function(row) {
          if (!byDay[row.day]) {
            byDay[row.day] = [];
          }
          byDay[row.day].push(row);
        });
        %>

      <div>
        <nav class="jump-to">
          <ul>
            <li><a href="#day-by-day">Jump to: <i class="fa fa-calendar" aria-hidden="true"></i> A day-by-day look at Trump's actions</a></li> 

            <li class="pipe"> | </li>

            <li><a href="http://www.seattletimes.com/nation-world/nation-politics/"><i class="fa fa-external-link" aria-hidden="true"></i> Read all our politics coverage</a></li>
          </ul>
        </nav>
      </div>

      <section class="dates-goals">

        <div class="checklist narrow" id="action-plan">
          <h2>100-day action plan</h2>

          <nav class="checklist-key">
            <input type="checkbox" class="plan-filter" id="completed">
            <label for="completed">
              <span class="text event complete"><i class="icon"></i> Promise kept</span>
            </label> 

            <input type="checkbox" class="plan-filter" id="broken">
            <label for="broken" class="broken">
              <span class="text event broken"><i class="icon"></i> Promise broken</span>
            </label>

            <input type="checkbox" class="plan-filter" id="in-progress">
            <label for="in-progress">
              <span class="text event progress"><i class="icon"></i> In progress</span>
            </label>             
            
            <input type="checkbox" class="plan-filter" id="incomplete">
            <label for="incomplete" class="incomplete">
              <span class="text event incomplete"><i class="icon"></i> Incomplete</span>
            </label>


            <!-- dropdown menu for categories -->

            <!-- creates an array with categories -->
            <% 
              var categories = [];

              function isInArray(categories, cat_title) {
                return categories.indexOf(cat_title) > -1;
              }

              json.goals.forEach(function(k) { 
                var cat_title = k.category;
                if (!isInArray(categories, cat_title)) {
                  categories.push(cat_title);
                }
              }) %>


            <select class="topics">
              <option value="">Filter by category</option>

              <% for (var i=0; i < categories.length; i++) { %>
                <option value=<%= categories[i] %>>
                  <%= categories[i] %>
                </option>
              <% } %>

            </select>
            <!-- end of menu -->




          </nav>


          <ol>
            <% var lookup = {} %>
            <% json.goals.forEach(function(k) {
              k.progress = ""; 
              if (k.day_completed) {
                k.progress = "completed";
              } else {
                if (k.in_progress) {
                  k.progress = "in-progress";
                } else {
                  if (k.day_broken) {
                    k.progress = "broken";
                    } else {
                        k.progress = "incomplete";
                    }
                }
              }
              %>



              <li class="plan-item" data-progress="<%= k.progress %>" data-topic="<%= k.category %>">

                <header class="label-container">
                  <div class="category-label <%= k.category.toLowerCase() %>"><%= k.category%></div>
                </header>

                <% if (k.day_completed) { lookup[k.day_completed] = true; %>
                  <span class="text event complete"><i class="icon"></i></span>
                <% } else if (k.in_progress) { lookup[k.in_progress] = true; %>
                  <span class="text event progress"><i class="icon"></i></span>
                  <% } else if (k.day_broken) { lookup[k.day_broken] = true; %>
                  <span class="text event broken"><i class="icon"></i></span>

                <% } else { %>
                  <span class="text event incomplete"><i class="icon"></i></span>
                <% } %>

                <%= k.goal %>

              <% if (k.day_completed) { %>
              (<a href="#day-<%= k.day_completed%>">Completed on Day <%= k.day_completed %></a>)
              <% } else if (k.in_progress) { %>
              (<a href="#day-<%= k.in_progress%>">Started process on Day <%= k.in_progress %></a>)
              <% } else if (k.day_broken) { %>
              (<a href="#day-<%= k.day_broken%>">Promise broken on Day <%= k.day_broken %></a>)
              <% }%>
            </li>
            <% }) %>
          </ol>

    </section>

    <div class="to-top"><a href="#action-plan">&uarr; Top</a></div>
    <hr>

    <section class="cal">
      <div class="narrow">
      <h2>Day-by-day day</h2>
      
      <div class="day-calendar" id="day-by-day">
        <div class="instructions">
          <p class="light-caps">Click on a bolded date to see what actions Trump took on that day.</p>
            <div class="actions-key-container">
              <ul class="actions-key">
                  <li class="event complete">
                    <i class="icon"></i> Promise kept
                  </li>

                  <li class="event broken">
                    <i class="icon"></i> Promise broken
                  </li>

                  <li class="event progress">
                    <i class="icon"></i> In progress
                  </li>
              </ul>
            </div>
          <!-- <ul class="key events calendar-legend">
            <li class="event complete">
              <i class="icon"></i> = Completed a promise
            </li> -->
    <!--           <li class="event progress">
              <i class="icon"></i> = Promise in progress
            </li> -->
          </ul>
        </div>
        <div class="calendar">

        <%= t.include("_calendar.html", { lookup, padding: 0, offset: 0, length: 31, ignored: 19, month: "january" }) %>

        <%= t.include("_calendar.html", { lookup, padding: 3, offset: 12, length: 28, ignored: 0, month: "february" }) %>

        <%= t.include("_calendar.html", { lookup, padding: 3, offset: 40, length: 31, ignored: 0, month: "march" }) %>

        <%= t.include("_calendar.html", { lookup, padding: 6, offset: 71, length: 30, ignored: 0, month: "april" }) %>

      </div>
    </section>

    <section class="actions">

        <% Object.keys(byDay).forEach(function(d) { 
          var actions = byDay[d]; 
          var when = moment("2017-01-20", "YYYY-MM-DD");
          when.add(d - 1, "days");
          %>

          <div class="day-no">
            <% if (d) { %>
              <h3 id="day-<%= d %>">Day <%= d %>  
                  <div class="actionDay">
                    <%= when.format("MMM D, YYYY") %>
                  </div>
              </h3>
            <% } %>

            <ul class="actions-list">
              <% actions.forEach(function(e) { %>
              <li class="event <%= e.status %>"> <i class="icon"></i> <%= e.summary %> 
                <% if (e.url) { %>
                <a href="<%= e.url %>"><%= e.link %></a>
                <% }
                   if (e.update) {%>
                    <div class="update">
                      <i class="fa fa-clock-o" aria-hidden="true"></i> <%= e.update %> <a href="<%=e.update_url%>"><%=e.update_link%></a>
                    </div>
                  <% }
                    else {
                     return;
                    } %>
              </li>
              <% }) %>
            </ul>
          </div>
          <% }) %>
        </div>

      </section>
      <div class="to-top"><a href="#day-by-day">&uarr; Top</a></div>

    </main>

    <script>
    window.goals = <%= JSON.stringify(json.goals) %>;
    window.daily = <%= JSON.stringify(json.daily) %>;
    </script>

    <script src="app.js" async></script>
    <% if (json.project.production) { %>
    <%= !json.project.embedded ? t.include("partials/_foot.html") : "" %>
    <%= t.include("partials/_workHere.html") %>
    <% } %>
  </body>
</html>
